<launch>
  <!-- Depth Image to Point Cloud -->
  <node pkg="nodelet" type="nodelet" name="nodelet_manager" args="manager" output="screen"/>
  
  <node pkg="nodelet" type="nodelet" name="depth_image_proc" args="load depth_image_proc/point_cloud_xyz nodelet_manager" output="screen">
    <remap from="camera_info" to="/iris/depth_camera/camera_info"/>
    <remap from="image_rect" to="/iris/depth_camera/depth/image_raw"/>
    <remap from="points" to="/iris/depth_camera/points"/>
  </node>

  <!-- Transform from VINS output to map or world if needed -->
  <!-- Assuming VINS outputs in "world" frame which equals "map" -->
  <node pkg="tf" type="static_transform_publisher" name="map_to_world" args="0 0 0 0 0 0 map world 100" />
  
  <!-- Ego Planner -->
  <!-- Note: This assumes 'ego_planner' package is installed or compiled -->
  <arg name="map_size_x" value="20.0"/>
  <arg name="map_size_y" value="20.0"/>
  <arg name="map_size_z" value="3.0"/>
  
  <!-- Use MAVROS odometry instead of VINS to avoid drift from low-rate simulation IMU -->
  <arg name="odom_topic" value="/mavros/local_position/odom" />

  <node pkg="ego_planner" name="ego_planner_node" type="ego_planner_node" output="screen">
    <rosparam command="load" file="$(find my_simulation)/config/ego_planner_config.yaml"/>
    
    <remap from="/odom_world" to="$(arg odom_topic)"/>
    <remap from="/grid_map/cloud" to="/iris/depth_camera/points"/>
    <remap from="/grid_map/pose" to="$(arg odom_topic)"/> <!-- Often needed for update -->
    
    <!-- Output trajectory -->
    <remap from="/planning/bspline" to="/ego_planner/trajectory"/>
    
    <param name="grid_map/resolution"      value="0.1" /> 
    <param name="grid_map/map_size_x"   value="$(arg map_size_x)" /> 
    <param name="grid_map/map_size_y"   value="$(arg map_size_y)" /> 
    <param name="grid_map/map_size_z"   value="$(arg map_size_z)" /> 
    <param name="grid_map/local_update_range_x"  value="5.5" /> 
    <param name="grid_map/local_update_range_y"  value="5.5" /> 
    <param name="grid_map/local_update_range_z"  value="4.5" /> 
    <param name="grid_map/obstacles_inflation"     value="0.099" /> 
    <param name="grid_map/local_map_margin" value="10"/>
    <param name="grid_map/ground_height"        value="-0.01"/>
    
    <param name="manager/max_vel" value="1.0" />
    <param name="manager/max_acc" value="2.0" />
    <param name="manager/max_jerk" value="4.0" />
    <param name="manager/control_points_distance" value="0.4" />
    <param name="manager/feasibility_tolerance" value="0.05" />
    <param name="manager/planning_horizon" value="7.5" />
    
    <!-- FSM Parameters -->
    <param name="fsm/flight_type" value="1" />
    <param name="fsm/thresh_replan" value="1.5" />
    <param name="fsm/thresh_no_replan" value="2.0" />
    <param name="fsm/planning_horizon" value="7.5" />
    <param name="fsm/planning_horizen_time" value="3" />
    <param name="fsm/emergency_time" value="1.0" />
    <param name="fsm/realworld_experiment" value="false" />
    <param name="fsm/fail_safe" value="true" />

    <param name="fsm/waypoint_num" value="-1" />

    <!-- Waypoint Generator (receives 2D Nav Goal from RViz) -->
    <remap from="/goal" to="/move_base_simple/goal"/>
    <remap from="/waypoint_generator/waypoints" to="/waypoint_generator/waypoints"/>
  </node>

  <!-- Add Waypoint Generator Node explicitly -->
  <node pkg="waypoint_generator" name="waypoint_generator" type="waypoint_generator" output="screen">
      <remap from="~goal" to="/move_base_simple/goal"/>
      <remap from="~odom" to="$(arg odom_topic)"/>        
      <param name="waypoint_type" value="manual-lonely-waypoint"/>    
  </node>

  <!-- Trajectory Server -->
  <node pkg="ego_planner" name="traj_server" type="traj_server" output="screen">
      <remap from="/planning/bspline" to="/ego_planner/trajectory"/>
      <remap from="/position_cmd" to="/planning/pos_cmd"/>
      <param name="traj_server/time_forward" value="1.0" />
  </node>

  <!-- TF from body to depth_camera_link -->
  <!-- <node pkg="tf" type="static_transform_publisher" name="tf_body_camera" args="0.1 0 0 0 0 0 body depth_camera_link 100" /> -->
  <node pkg="tf" type="static_transform_publisher" name="tf_base_link_camera" args="0.1 0 0 0 0 0 base_link depth_camera_link 100" />
  
  <!-- Additional frames for MAVROS/Model compatibility -->
  <!-- DISABLED: body -> base_link to avoid conflict with MAVROS odom -> base_link -->
  <!-- <node pkg="tf" type="static_transform_publisher" name="body_to_base_link" args="0 0 0 0 0 0 body base_link 100" /> -->
  
  <!-- Add base_link -> base_link_frd for compatibility -->
  <node pkg="tf" type="static_transform_publisher" name="base_link_frd_tf" args="0 0 0 0 0 0 base_link base_link_frd 100" />
  
  <!-- Connect world to odom so map -> world -> odom -> base_link works -->
  <node pkg="tf" type="static_transform_publisher" name="world_to_odom" args="0 0 0 0 0 0 world odom 100" />

  
</launch>
